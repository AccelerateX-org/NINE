@using MyStik.TimeTable.Web.Helpers
@model MyStik.TimeTable.Web.Models.LotteryGambleViewModel
@{
    ViewBag.Title = "Platzverlosung";
    var x = DateTime.Now.ToString("s");
}

@section styles{
    <link rel="stylesheet" href="@Url.Content("~/Assets/global/plugins/ion.rangeslider/css/ion.rangeSlider.css")" />
    <link rel="stylesheet" href="@Url.Content("~/Assets/global/plugins/ion.rangeslider/css/ion.rangeSlider.skinFlat.css")" />
}

<div class="panel panel-default">
    <div class="panel-body bg-fillter-study">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-12">
                    <h1>Platzverlosung @Model.Lottery.Name</h1>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid" id="lotteryView">
    <div class="row">
        <div class="col-md-6">
            <div class="portlet light bordered">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject bold">Verlosung</span>
                    </div>
                </div>
                <div class="portlet-body">
                    @if (ViewBag.NextDrawing != null)
                    {
                        <h4>Nächste Verlosung am: @ViewBag.NextDrawing</h4>
                        <p id="lotteryTimer"></p>
                    }
                    else
                    {
                        <h4>Verlosung ist beendet</h4>
                        <p>Ein-/Austragen noch möglich. Es können keine Punkte mehr gesetzt werden.</p>
                    }
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="portlet light bordered">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject bold">Punktebudgets</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="list-group-item">
                        <h4 class="list-group-item-heading">Warteliste</h4>
                        <p class="list-group-item-text">
                            1 Punkt pro Tag auf der Warteliste (ohne Unterbrechung)
                        </p>
                    </div>
                    @foreach (var budget in Model.BudgetStates)
                    {
                        <div class="list-group-item">
                            <h4 class="list-group-item-heading">@budget.Budget.Name</h4>
                            <p class="list-group-item-text">
                                <ul class="fa-ul">
                                    <li><i class="fa-li fa fa-info"></i>Beschreibung: @Html.Raw(budget.Budget.Description)</li>
                                    <li><i class="fa-li fa fa-money"></i>Punkte: @budget.Budget.Size</li>
                                </ul>
                                <p>Bisher Eingesetzt</p>
                                <ul>
                                    @foreach (var bet in budget.Bets)
                                    {
                                        <li>@bet.Amount</li>
                                    }
                                </ul>
                            </p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>


    <div class="row">
        <div class="col-md-12">
            @foreach (var course in Model.Courses)
            {
                var i = 0;

                <div class="row">
                    <div class="col-md-12">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                    <h4>@course.Course.Name (@course.Course.ShortName)</h4>
                            </div>
                            <div class="panel-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="panel panel-default">
                                            <div class="panel-body">
                                            <ul class="fa-ul">
                                                <li><i class="fa-li fa fa-group"></i>Semestergruppe(n): @Html.GroupList(course.Course.SemesterGroups)</li>
                                                <li><i class="fa-li fa fa-graduation-cap"></i>Dozent(en): @Html.LecturerList(course.Summary.Lecturers)</li>
                                                @if (course.Summary.Dates.Count > 1)
                                                {
                                                    <li><i class="fa-li fa fa-calendar"></i>Termine: verschiedene Wochentage/Zeiten</li>
                                                }
                                                else
                                                {
                                                    <li><i class="fa-li fa fa-calendar"></i>@Html.DateList(course.Summary.Dates)</li>
                                                }
                                                <li><i class="fa-li fa fa-info-circle"></i>Beschreibung etc. <a href="@Url.Action("Details", "Course", new {id=course.Course.Id})">hier</a></li>
                                                <li class="list"></li>
                                            </ul>
                                            <ul class="list-group">
                                                <li class="list-group-item list-group-item-info">Insgesamt <strong>@course.Capacity</strong> Pätze</li>
                                             </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div id="@course.Course.Id">
                                            @Html.Partial("_BetState", course)
                                        </div>
                                    </div>
                                    @if (course.Subscription != null)
                                    {
                                        if (course.Subscription.OnWaitingList)
                                        {
                                            <div class="col-md-3">
                                                <div id="@course.Subscription.Id">
                                                    @Html.Partial("_BetView", course)
                                                </div>
                                            </div>
                                        }
                                        else
                                        {
                                            if (course.Subscription.IsConfirmed)
                                            {
                                                <div class="col-md-3">
                                                    <button type="button" class="btn btn-danger btn-sm" data-toggle="modal" data-target="#myModal"
                                                            data-lotteryid="@Model.Lottery.Id" data-occurrencid="@course.Subscription.Occurrence.Id">
                                                        <i class="fa fa-times"></i> Platz zurückgeben
                                                    </button>
                                                </div>
                                            }
                                            else
                                            {
                                                if (Model.Confirmed < Model.Lottery.MaxConfirm)
                                                {
                                                    <div class="col-md-3">
                                                        <button type="button" class="btn btn-success btn-sm" data-toggle="modal" data-target="#myModal2"
                                                                data-lotteryid="@Model.Lottery.Id" data-occurrencid="@course.Subscription.Occurrence.Id">
                                                            <i class="fa fa-pencil"></i> Reservierung bestätigen
                                                        </button>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="col-md-3">
                                                        <h4>Habe bereits die max. Anzahl an Reservierungen bestätigt. Kann keine weiteren Reservierungen mehr bestätigen</h4>
                                                        <a href="@Url.Action("Discharge", "Lottery",new { occId = course.Subscription.Occurrence.Id, lotId = Model.Lottery.Id })" 
                                                           class="btn btn-default"><i class="fa fa-times"></i> Austragen</a>
                                                    </div>
                                                }

                                            }
                                        }
                                    }
                                    else
                                    {
                                        <div class="col-md-3">
                                            <a href="@Url.Action("Subscribe", "Lottery", new {occId = course.Course.Occurrence.Id, lotId = Model.Lottery.Id})" class="btn btn-default btn-block">
                                                <i class="fa fa-pencil"></i> Eintragen und Punkte einsetzen
                                            </a>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>




<div class="container-fluid" id="drawingView" hidden>
    <div class="row">
        <div class="col-md-12">
            
            <h1><i class="fa fa-random"></i> Verlosung läuft
            </h1>
            <a href="@Url.Action("MySelection", new {id = Model.Lottery.Id})" class="btn btn-default btn-lg"><i class="fa fa-refresh"></i> Aktualisieren</a>
        </div>
    </div>
</div>

    <!-- Modal -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Platz zurückgeben</h4>
                </div>
                <div class="modal-body">
                    <p>Wenn ich den Platz zurückgebe, dann rutsche ich an das Ende der Warteliste. Das verringert die Chancen später wieder eine Reserverierung in dieser Lehrveranstaltung zu erhalten.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Abbrechen</button>
                    <a id="modalBtnRelease" href="" class="btn btn-danger"><i class="fa fa-times"></i> Ja, ich will diesen Platz zurückgeben</a>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="myModal2" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Reservierung bestätigen</h4>
                </div>
                <div class="modal-body">
                    <p>Wenn ich diese Reservierung bestätige, dann habe ich mir einen Platz gesichert. Ich kann unter Umständen keine weitere Reservierung mehr in dieser Lotterie bestätigen.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Abbrechen</button>
                    <a id="modalBtnConfirm" href="" class="btn btn-success"><i class="fa fa-pencil"></i> Ich will die Reservierung bestätigen</a>
                </div>
            </div>
        </div>
    </div>



    @section scripts{
        <script src="@Url.Content("~/Assets/global/plugins/ion.rangeslider/js/ion.rangeSlider.min.js")" type="text/javascript"></script>
        <script src="@Url.Content("~/Assets/global/plugins/jquery.sparkline.min.js")" type="text/javascript"></script>

        <script>
            $('#myModal').on('show.bs.modal',
                function (event) {
                    var button = $(event.relatedTarget); // Button that triggered the modal
                    var lotteryId = button.data('lotteryid'); // Extract info from data-* attributes
                    var occurrenceId = button.data('occurrencid'); // Extract info from data-* attributes

                    // If necessary, you could initiate an AJAX request here (and then do the updating in a callback).
                    // Update the modal's content. We'll use jQuery here, but you could use a data binding library or other methods instead.
                    //var modal = $('#modelBtnConfirm');
                    //modal.find('#modelBtnConfirm').
                    var href = '/Lottery/Release?lotId=' + lotteryId + '&occId=' + occurrenceId;
                    $('#modalBtnRelease').attr('href', href);
                })
        </script>

        <script>
            $('#myModal2').on('show.bs.modal',
                function (event) {
                    var button = $(event.relatedTarget); // Button that triggered the modal
                    var lotteryId = button.data('lotteryid'); // Extract info from data-* attributes
                    var occurrenceId = button.data('occurrencid'); // Extract info from data-* attributes

                    // If necessary, you could initiate an AJAX request here (and then do the updating in a callback).
                    // Update the modal's content. We'll use jQuery here, but you could use a data binding library or other methods instead.
                    //var modal = $('#modelBtnConfirm');
                    //modal.find('#modelBtnConfirm').
                    var href = '/Lottery/Confirm?lotId=' + lotteryId + '&occId=' + occurrenceId;
                    $('#modalBtnConfirm').attr('href', href);
                })
        </script>
        
        @if (ViewBag.NextDrawing != null)
        {
            <script>
                // Set the date we're counting down to
                var countDownDate = new Date('@ViewBag.NextDrawing.ToString("s")').getTime();

// Update the count down every 1 second
                var x = setInterval(function() {

                        // Get todays date and time
                        var now = new Date().getTime();

                        // Find the distance between now an the count down date
                        var distance = countDownDate - now;

                        // Time calculations for days, hours, minutes and seconds
                        var days = Math.floor(distance / (1000 * 60 * 60 * 24));
                        var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                        var seconds = Math.floor((distance % (1000 * 60)) / 1000);

                        // Display the result in the element with id="demo"
                        document.getElementById("lotteryTimer").innerHTML =
                            days + "d " + hours + "h " + minutes + "m " + seconds + "s ";

                        // If the count down is finished, write some text
                        if (distance < 0) {
                            clearInterval(x);
                            document.getElementById("lotteryTimer").innerHTML = "EXPIRED";
                            $("#lotteryView").hide();
                            $("#drawingView").show();
                        }
                    },
                    1000);
            </script>
        }
    }
