@using MyStik.TimeTable.Data
@using MyStik.TimeTable.Web.Services
@model MyStik.TimeTable.Web.Models.CatalogPlanModel
@{
    ViewBag.Title = "Katalogplanung";

    var db = new TimeTableDbContext();
    var courseService = new CourseService(db);

    var allCourses = db.Activities.OfType<Course>()
        .Where(x => 
            x.Semester.Id == Model.Semester.Id && x.Organiser.Id == Model.Organiser.Id &&
            x.SubjectTeachings.Any(t => t.Subject.Module.Catalog.Id == Model.Catalog.Id))
        .ToList();

    var allLecturers = new List<OrganiserMember>();
    var allRooms = new List<Room>();
    var allLabels = new List<ItemLabel>();

    foreach (var course in allCourses)
    {
        var summary = courseService.GetCourseSummary(course);

        allLecturers.AddRange(summary.Lecturers);
        allRooms.AddRange(summary.Rooms);
        allLabels.AddRange(course.LabelSet.ItemLabels);
    }

    allLecturers = allLecturers.Distinct().ToList();
    allRooms = allRooms.Distinct().ToList();
    allLabels = allLabels.Distinct().ToList();
}


@section styles
{
    <link href="~/Assets/libs/fullcalendar/main.min.css" rel="stylesheet" />
}


<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4>Planungssicht für @Model.Catalog.Name</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-2">
                        <div class="form-floating mb-3">
                            <select class="form-select" id="selectSemster" onchange="onSemesterChanged(this.value)">
                                @foreach (var sem in ViewBag.Semester)
                                {
                                    if (sem.Id == Model.Semester.Id)
                                    {
                                        <option selected value="@sem.Id">@sem.Name</option>
                                    }
                                    else
                                    {
                                        <option value="sem.Id">@sem.Name</option>
                                    }
                                }
                            </select>
                            <label for="selectSemster">Semester</label>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-floating mb-3">
                            <select class="form-select" id="selectSection" onchange="onSectionChanged(this.value)">
                            </select>
                            <label for="selectSection">Abschnitt</label>
                        </div>

                    </div>
                    <div class="col-md-2">
                        <div class="form-floating mb-3">
                            <select class="form-select" id="selectOrg" onchange="onOrgChanged(this.value)">
                                <option selected value="@Model.Organiser.Id">@Model.Organiser.ShortName</option>
                            </select>
                            <label for="selectOrg">Einrichtung</label>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-floating mb-3">
                            <select class="form-select" id="selectCat" onchange="onCatalogChanged(this.value)">
                                <option selected value="@Model.Catalog.Id">@Model.Catalog.Tag</option>
                            </select>
                            <label for="selectCat">Modulkatalog</label>
                        </div>
                    </div>
                    <div class="col-md-2">

                    </div>
                    <div class="col-md-2">
                        <div class="btn-group">
                            <a href="javascript:onPrev()" class="btn btn-outline-secondary btn-sm"><i class="bi-chevron-left"></i></a>
                            <a href="javascript:onNext()" class="btn btn-outline-secondary btn-sm"><i class="bi-chevron-right"></i></a>
                            <a href="javascript:toggleWeekend()" class="btn btn-outline-secondary btn-sm"><i class="bi-calendar-week"></i></a>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <h5>Angebotene Lehrveranstaltungen</h5>
                        <div class="list-group">
                            @foreach (var module in Model.Catalog.Modules)
                            {
                                <div class="list-group-item p-0">
                                <div class="row g-0">
                                    <div class="col-md-8">
                                        <div class="card" style="height: 100%">
                                            <div class="card-body pt-0 pb-0">
                                                <div class="text-truncate">
                                                    <strong>@module.Name</strong>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        @foreach (var subject in module.ModuleSubjects)
                                        {
                                        <div class="row g-0">
                                            <div class="col-md-6">
                                                <div class="card" style="height: 100%">
                                                    <div class="card-body pt-0 pb-0">
                                                        @subject.Tag
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="card">
                                                    <div class="list-group list-group-flush">
                                                        @foreach (var teaching in subject.SubjectTeachings.Where(x => x.Course.Semester.Id == Model.Semester.Id))
                                                        {
                                                            <div class="list-group-item pt-0 pb-0">
                                                                @teaching.Course.ShortName
                                                            </div>
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        }
                                    </div>
                                </div>
                                </div>
                            }
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="row">
                            <div class="col-md-12">
                                <div id="calendar"></div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <h5>Eingesetzte Lehrende</h5>
                                <div class="card">
                                    <div class="row g-0 gy-1">
                                        @foreach (var lecturer in allLecturers)
                                        {
                                            <div class="col-3">
                                                <a id="@lecturer.Id" href="javascript:toggleDoz('@lecturer.Id.ToString()')" class="btn btn-secondary btn-sm" style="width: 100%">@lecturer.ShortName</a>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h5>Verwendete Räume</h5>
                                <div class="card">
                                    <div class="row g-0 gy-1">
                                        @foreach (var room in allRooms)
                                        {
                                            <div class="col-3">
                                                <div class="btn btn-secondary btn-sm" style="width: 100%">
                                                    @room.Number
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h5>Betroffene Kohorten</h5>
                                <div class="card">
                                    <div class="row g-0 gy-1">
                                        @foreach (var label in allLabels)
                                        {
                                            <div class="col-3">
                                                <div class="btn btn-secondary btn-sm" style="width: 100%">
                                                    @label.Name
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts
{
    <script src="~/Assets/libs/fullcalendar/main.min.js"></script>
    <script src="~/Assets/libs/fullcalendar/locales/de.js"></script>
    <script src="~/Assets/fillter/scripts/calendar.js"></script>


    <script>
        var myCalendar = null;
        var mySelection = "";
        var showWeekend = true;
        var dozIds = [];

        $(function() {
            $("#loading").hide();

            showWeekCalendar();

        });

        function onPrev() {
            myCalendar.prev();
        }
        function onNext() {
            myCalendar.next();
        }
        function toggleWeekend() {
            showWeekend = !showWeekend;
            myCalendar.setOption("weekends", showWeekend);
        }

        function toggleDoz(id) {
            console.log(id);
            if (dozIds.includes(id)) {
                $("#" + id).removeClass("active");
                i = dozIds.indexOf(id);
                dozIds.splice(i, 1);
            } else {
                $("#" + id).addClass("active");
                dozIds.push(id);
            }


        }


        function showWeekCalendar() {
            try {
                $('#loading').show();
                // Definition der LVs, die angezeigt werden sollen
                // Basis
                // Semester && Abschnitt
                // Org && Catalog
                // Option: Studiengang als Filter
                // Overlays: null wenn kein Overlay, Liste wenn Overlay
                // dozIds
                // roomIds
                // labelIds
                semId = "@Model.Semester.Id";
                orgId = "@Model.Organiser.Id";
                @*
                    labelId = "@Model.Label.Id";
                    currId = "@Model.Curriculum.Id";
                    *@

                $('#calendar').html('');
                myCalendar = initDayCalendar("calendar");

                myCalendar.setOption("headerToolbar", false);
                //myCalendar.setOption("slotDuration", "00:90:00");

                @*
                myCalendar.addEventSource(
                    {
                        url: '@Url.Action("LabelEvents", "Calendar")',
                        method: 'POST',
                        extraParams: {
                            semId: semId,
                            orgId: orgId,
                            labelId: labelId,
                            currId: currId,

                        },
                        success: function(data, success, xhr) {
                            $('#loading').hide();
                        },
                        failure: function(data, type, ex) {
                            strMessage =
                                "<div class=\"alert alert-danger\"><h4>Fehler beim Laden der Daten</h4>";
                            strMessage += "<p>Grund: " + ex + data + type + "</p>";
                            strMessage += "</div>";

                            $('#calendar').html(strMessage);
                            //alert("Fehler beim laden der Daten." + ex);
                            $('#loading').hide();
                        }
                    }
                );
                    *@
            } catch (err) {
                var strMessage =
                    "<div class=\"alert alert-danger\"><h4>Fehler beim Laden der Daten</h4>";
                strMessage += "<p>Grund: " + err + "</p>";
                strMessage += "<p>Abhilfe: Den Brwoser Cache leeren, z.B. mit der Tastenkombination CTRL + F5 bzw. Strg + F5</p>";
                strMessage += "</div>";

                $('#calendar').html(strMessage);
                $('#loading').hide();
            }

        }



        function onSourceOrgChanged(value) {
            var orgId = value;
            $("#loading").show();

            $.ajax(
                {
                    type: "POST",
                    url: '@Url.Action("GetCatalogs")',
                    data: {
                        orgId: orgId
                    },
                    success: function(data, success, xhr) {
                        $("#sourceCat").html(data);
                        $("#sourceCat").change();
                        $("#loading").hide();
                    }
                });

        }

        function onSourceCatChanged(value) {

            updateMoveState();
            var catId = value;
            $("#loading").show();

            $.ajax(
                {
                    type: "POST",
                    url: '@Url.Action("GetModules")',
                    data: {
                        catId: catId,
                        side: "source"
                    },
                    success: function(data, success, xhr) {
                        $("#sourceModules").html(data);
                        $("#loading").hide();
                    }
                });

        }

        function onTargetOrgChanged(value) {
            var orgId = value;
            $("#loading").show();

            $.ajax(
                {
                    type: "POST",
                    url: '@Url.Action("GetCatalogs")',
                    data: {
                        orgId: orgId
                    },
                    success: function(data, success, xhr) {
                        $("#targetCat").html(data);
                        $("#targetCat").change();
                        $("#loading").hide();
                    }
                });

        }

        function onTargetCatChanged(value) {

            updateMoveState();
            var catId = value;
            $("#loading").show();

            $.ajax(
                {
                    type: "POST",
                    url: '@Url.Action("GetModules")',
                    data: {
                        catId: catId,
                        side: "target"
                    },
                    success: function(data, success, xhr) {
                        $("#targetModules").html(data);
                        $("#loading").hide();
                    }
                });
        }


    </script>
}
