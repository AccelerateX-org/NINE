@using MyStik.TimeTable.Data
@using MyStik.TimeTable.Web.Helpers
@model MyStik.TimeTable.Web.Models.TeachingOverviewModel
@{
    /*if (Request.IsLocal)
    {
        Layout = "~/Views/Shared/_LayoutDashboardNew.cshtml";
    }
    */
    ViewBag.Title = "Dashboard";

    var db = new TimeTableDbContext();

    var now = DateTime.Now;
    var day = DateTime.Today.AddDays(-7);
    var nAds = db.Advertisements.Count(x => x.Created >= day);

}


@section styles
{
    <link rel="stylesheet" type="text/css" href="@Url.Content("~/Assets/libs/bootstrap-datepicker/css/bootstrap-datepicker3.min.css")" />
}

<div class="row">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a aria-label="Dashboard" href="@Url.Action("Index", "Dashboard")"><i class="bi bi-grid"></i></a></li>
            <li class="breadcrumb-item"><a aria-label="Campus" href="@Url.Action("Campus", "University")">HM</a></li>

            @if (Model.Organisers.Any())
            {
                <li class="breadcrumb-item">
                    @foreach (var org in Model.Organisers.OrderBy(x => x.ShortName))
                    {
                        <a aria-label="@org.ShortName" href="@Url.Action("Faculty", "University", new { id = org.Id })">@org.ShortName</a>
                    }
                </li>
            }

            @if (Model.Students.Any())
            {
                <li class="breadcrumb-item">
                    @foreach (var student in Model.Students.OrderBy(x => x.Created))
                    {
                        <a aria-label="@student.Curriculum.ShortName" href="@Url.Action("Curricula", "Subscription")">@student.Curriculum.ShortName</a>
                    }
                </li>
            }
        <li class="breadcrumb-item">
            <div class="btn-group">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="switchLayout" onchange="onSwitchLayout()" aria-label="Schalter Layout">
                    <label class="form-check-label" for="switchLayout" id="switchLayoutLabel">Anzeige: neues Layout</label>
                </div>
                @*
                <a class="btn btn-sm btn-outline-secondary" href="@Url.Action("Settings")"><i class="bi bi-gear"></i></a>
                *@
            </div>
        </li>
        </ol>
    </nav>
</div>
@if (Request.IsLocal)
{
    <div class="row">
        <div class="col-md-12">
            <a href="https://localhost:44300/Course/Details/7dfad981-d23d-ee11-855b-7486e20bbe7b">Testkurs</a>
            <a href="https://localhost:44300/ModuleDescription/Semester?moduleId=9a068d88-77cc-ed11-8520-7486e20bbe7b&semId=17f321e3-76cc-ed11-8520-7486e20bbe7b">Testmodul</a>
        </div>
    </div>
}

<div id="oldLayout" class="row">
    <div class="col-md-4">
        @if (Model.Candidatures.Any())
        {
            <div class="row">
                <div class="col-md-12">
                    <div class="card mb-3">
                        <div class="card-header bg-white">
                            <div class="d-flex justify-content-between align-items-start">
                                <h5 class="card-title">Meine Aufnahmeverfahren</h5>
                            </div>
                        </div>
                        <div class="list-group">
                            <a href="@Url.Action("Index", "Candidature")" class="list-group-item list-group-item-action"><i class="bi bi-journals"></i> Übersicht</a>
                        </div>
                    </div>
                </div>
            </div>
        }
        @if (Model.Student != null && Model.Student.LastSemester == null)
        {
            <div class="row">
                <div class="col-md-12">
                    <div class="card mb-3">
                        <div class="card-header bg-white">
                            <div class="d-flex justify-content-between align-items-start">
                                <h5 class="card-title">Ich studiere <strong>@Model.Student.Curriculum.ShortName</strong> seit @Model.Student.FirstSemester.Name</h5>
                                @if (Model.Student.LabelSet != null && Model.Student.LabelSet.ItemLabels.Any())
                                {
                                    <div>
                                        @foreach (var label in Model.Student.LabelSet.ItemLabels)
                                        {
                                            <span>@label.Name</span>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                        <div class="list-group">
                            <a class="list-group-item list-group-item-action" href="@Url.Action("Curricula", "Subscription")">
                                Studiengang ändern / wechseln / beenden
                            </a>
                            <a href="@Url.Action("Details", "Curriculum", new { id = Model.Student.Curriculum.Id })" class="list-group-item list-group-item-action">
                                Aufbau und Modulplan
                            </a>
                            @if (Model.Thesis != null)
                            {
                                if (Model.Thesis.DeliveryDate == null) // noch nicht abgegeben
                                {
                                    if (Model.Thesis.IssueDate == null) // noch nicht angemeldet
                                    {
                                        if (Model.Thesis.Supervisors.Any(x => x.AcceptanceDate != null)) // Arbeit wurde angenommen
                                        {
                                            <a href="@Url.Action("Issue", "Thesis")" class="list-group-item list-group-item-action list-group-item-danger">
                                                Meine Abschlussarbeit ist noch nicht angemeldet!
                                            </a>
                                        }
                                        else
                                        {
                                            <a href="@Url.Action("Index", "Thesis")" class="list-group-item list-group-item-action list-group-item-info">
                                                Habe in NINE schon eine Abschlussarbeit angelegt, aber noch nicht offiziell damit begonnen.
                                            </a>
                                        }
                                    }
                                    else
                                    {
                                        var diff = Model.Thesis.ExpirationDate.Value.Date - DateTime.Today;
                                        var isProlonged = false;
                                        if (Model.Thesis.RenewalDate != null)
                                        {
                                            isProlonged = true;
                                            diff = Model.Thesis.RenewalDate.Value.Date - DateTime.Today;
                                        }

                                        if (isProlonged)
                                        {
                                            <a href="@Url.Action("Index", "Thesis")" class="list-group-item list-group-item-action list-group-item-danger">
                                                Abgabefrist meiner Abschlussarbeit (verlängert): @Model.Thesis.RenewalDate.Value.Date.ToShortDateString()
                                            </a>
                                        }
                                        else
                                        {
                                            <a href="@Url.Action("Index", "Thesis")" class="list-group-item list-group-item-action list-group-item-info">
                                                Abgabefrist meiner Abschlussarbeit: @Model.Thesis.ExpirationDate.Value.Date.ToShortDateString()
                                            </a>
                                        }
                                    }
                                }
                                else
                                {
                                    if (Model.Thesis.GradeDate == null)
                                    {
                                        <a href="@Url.Action("Index", "Thesis")" class="list-group-item list-group-item-action list-group-item-info">
                                            Die Abgabe wurde am @Model.Thesis.DeliveryDate.Value.ToShortDateString() erfasst.
                                        </a>
                                    }
                                    else
                                    {
                                        <div class="list-group-item">
                                            Die Note wurde am @Model.Thesis.GradeDate.Value.ToShortDateString() gemeldet. In der Regel ist dies auch der Abschluss des Studiums
                                            <small>Ist der Studiengang noch aktuell?</small>
                                        </div>
                                        <a href="@Url.Action("StayConnected", "Alumni", new { id = Model.Thesis.Student.Id })" class="list-group-item list-group-item-action list-group-item-info">
                                            Erfassung der Kontaktdaten für Alumni-Datenbank
                                        </a>
                                    }
                                }
                            }
                            else
                            {
                                if (Model.Student.Curriculum.ThesisDuration > 0)
                                {
                                    <a href="@Url.Action("Index", "Thesis")" class="list-group-item list-group-item-action">
                                        Abschlussarbeit: bisher nicht begonnen
                                    </a>
                                }
                            }
                        </div>
                    </div>
                </div>
            </div>
        }



        <div class="row">
            <div class="col-md-12">
                <div class="card mb-3">
                    <div class="card-header bg-white">
                        <div class="d-flex justify-content-between align-items-start">
                            <h5 class="card-title">Agenda</h5>
                            <input id="dateAgenda" type="text" class="form-control form-control-sm datepicker" aria-label="Current date" onchange="onDateChanged(value)" value="@DateTime.Today.ToString(ViewBag.Culture.DateTimeFormat.ShortDatePattern)" />
                            <div class="btn-group">

                                @if (Model.Organisers.Any())
                                {
                                    if (Model.Organisers.Count == 1)
                                    {
                                        var org = Model.Organisers.First();
                                        <a aria-label="day" class="btn btn-sm btn-outline-secondary" href="@Url.Action("Today", "Activity", new { id = org.Id })">
                                            <i class="bi bi-calendar-day"></i>
                                        </a>
                                    }
                                    else
                                    {
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Select faculty">
                                                <i class="bi bi-calendar-day"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                @foreach (var org in Model.Organisers.OrderBy(x => x.ShortName))
                                                {
                                                    <li>
                                                        <a class="dropdown-item" href="@Url.Action("Today", "Activity", new { id = org.Id })">@org.ShortName</a>
                                                    </li>
                                                }
                                            </ul>
                                        </div>
                                    }
                                }

                                <a aria-label="Personal Plan" class="btn btn-sm btn-outline-secondary" href="@Url.Action("PersonalPlan", "Activity")"><i class="bi bi-calendar-heart"></i></a>
                                <a aria-label="Free Rooms" class="btn btn-sm btn-outline-secondary" href="@Url.Action("Free", "Room")"><i class="bi bi-building-check"></i></a>
                            </div>
                        </div>
                    </div>
                    <div id="placeholderAgenda">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title placeholder-glow">
                                    <span class="placeholder col-6"></span>
                                </h5>
                                <p class="card-text placeholder-glow">
                                    <span class="placeholder col-7"></span>
                                    <span class="placeholder col-4"></span>
                                    <span class="placeholder col-4"></span>
                                    <span class="placeholder col-6"></span>
                                    <span class="placeholder col-8"></span>
                                </p>
                                <a class="btn btn-primary disabled placeholder col-6" aria-disabled="true"></a>
                            </div>
                        </div>
                    </div>
                    <div id="listAgenda" class="list-group">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="row">
            <div id="refreshSemester">
                <a class="btn btn-outline-primary" href="javascript:onSemesterChanged()"><i class="bi bi-arrow-repeat"></i> Refresh</a>
            </div>
            <div id="placeholderSemester">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title placeholder-glow">
                            <span class="placeholder col-6"></span>
                        </h5>
                        <p class="card-text placeholder-glow">
                            <span class="placeholder col-7"></span>
                            <span class="placeholder col-4"></span>
                            <span class="placeholder col-4"></span>
                            <span class="placeholder col-6"></span>
                            <span class="placeholder col-8"></span>
                        </p>
                        <a class="btn btn-primary disabled placeholder col-6" aria-disabled="true"></a>
                    </div>
                </div>
            </div>

            <div id="cardSemester" class="col-md-12">
            </div>
        </div>



    </div>
    <div class="col-md-2">
        @if (Model.Members.Any())
        {
            <div class="row">
                <div class="col-md-12">
                    <div class="card mb-3">
                        <div class="card-header bg-white">
                            <div class="d-flex justify-content-between align-items-start">
                                <h5 class="card-title">BA/MA-Arbeiten</h5>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="bi bi-list"></i> Listen
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#">Ausschreibungen</a></li>
                                        <li><a class="dropdown-item" href="@Url.Action("Index", "ThesisSupervision")">Übersicht</a></li>
                                        <li><a class="dropdown-item" href="@Url.Action("Cleared", "ThesisSupervision")">Abgerechnete</a></li>
                                    </ul>
                                </div>
                            </div>

                        </div>
                        <div class="list-group">
                            @foreach (var thesis in Model.ActiveTheses)
                            {
                                if (thesis.User != null)
                                {

                                    if (thesis.Thesis.DeliveryDate != null)
                                    {
                                        <a class="list-group-item list-group-item-action" href="@Url.Action("Details", "ThesisSupervision", new { id = thesis.Thesis.Id })">
                                            <i class="bi bi-trophy"></i> @thesis.User.FullName (@thesis.Student.Curriculum.ShortName)
                                        </a>
                                    }
                                    else
                                    {
                                        if (thesis.Thesis.Supervisors.Any(x => x.AcceptanceDate == null))
                                        {
                                            <a class="list-group-item list-group-item-action" href="@Url.Action("Details", "ThesisSupervision", new { id = thesis.Thesis.Id })">
                                                <i class="fas fa-question-circle"></i>
                                                @thesis.User.FullName (@thesis.Student.Curriculum.ShortName)
                                                <span class="badge bg-danger">Betreuungsanfrage</span>
                                            </a>
                                        }
                                        else
                                        {
                                            <a class="list-group-item list-group-item-action" href="@Url.Action("Details", "ThesisSupervision", new { id = thesis.Thesis.Id })">
                                                <i class="bi bi-gear"></i>
                                                @thesis.User.FullName (@thesis.Student.Curriculum.ShortName)
                                                @if (thesis.DaysToExpire == Int32.MaxValue)
                                                {
                                                    <span class="badge bg-danger">Noch nicht angemeldet</span>
                                                }
                                                else
                                                {
                                                    if (thesis.Thesis.RenewalDate != null)
                                                    {
                                                        <span class="badge bg-secondary">@thesis.DaysToExpire Tage bis zur Abgabe (verlängert)</span>
                                                    }
                                                    else
                                                    {
                                                        if (thesis.Thesis.ProlongRequestDate == null)
                                                        {
                                                            <span class="badge bg-secondary">@thesis.DaysToExpire Tage bis zur Abgabe</span>
                                                        }
                                                        else
                                                        {
                                                            if (thesis.Thesis.ProlongSupervisorAccepted == null)
                                                            {
                                                                <span class="badge bg-danger">Antrag auf Verlängerung - unbearbeitet</span>
                                                            }
                                                            else
                                                            {
                                                                <span class="badge bg-secondary">Antrag auf Verlängerung akzeptiert - Bestätigung PKV steht noch aus</span>
                                                            }

                                                        }
                                                    }

                                                }
                                            </a>
                                        }
                                    }
                                }
                                else
                                {
                                    if (thesis.Thesis.DeliveryDate != null)
                                    {
                                        <a class="list-group-item list-group-item-action" href="@Url.Action("Details", "ThesisSupervision", new { id = thesis.Thesis.Id })">
                                            <i class="bi bi-trophy"></i> Unbekannt (@thesis.Student.Curriculum.ShortName)
                                        </a>
                                    }
                                    else
                                    {
                                        <a class="list-group-item list-group-item-action" href="@Url.Action("Details", "ThesisSupervision", new { id = thesis.Thesis.Id })">
                                            <i class="bi bi-gear"></i> Unbekannt (@thesis.Student.Curriculum.ShortName)
                                            <span class="badge bg-secondary">@thesis.DaysToExpire</span>
                                        </a>
                                    }

                                }
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<div id="newLayout" class="row">
    <div class="col-md-2 col-2">
        <nav aria-label="Seitenmenü">
            <div class="card mb-3">
                            <div class="list-group">
                                <a href="@Url.Action("PersonalPlan", "Activity")" class="list-group-item list-group-item-action" aria-label="Kalender"><i class="bi bi-calendar-day"></i><span class="d-none d-sm-inline"> Kalender</span></a>
                                <a href="@Url.Action("PersonalPlanWeekly", "Activity")" class="list-group-item list-group-item-action" aria-label="Stundenplan"><i class="bi bi-calendar-week"></i><span class="d-none d-sm-inline"> Stundenplan</span></a>
                                @if (Model.Student != null && Model.Student.LastSemester == null)
                                {
                                    <a href="@Url.Action("Subscriptions", "OfficeHour")" class="list-group-item list-group-item-action" aria-label="Sprechstundentermine"><i class="bi bi-person-check"></i><span class="d-none d-sm-inline"> Sprechstundentermine</span></a>
                                    @*
                                    <a class="list-group-item list-group-item-action" href="@Url.Action("Curricula", "Subscription")" aria-label="Studienbuch">
                                        <i class="bi bi-mortarboard"></i><span class="d-none d-sm-inline"> @Model.Student.Curriculum.ShortName</span>
                                    </a>
                                    *@
                                    if (Model.Thesis != null)
                                    {
                                        <a href="@Url.Action("Index", "Thesis")" class="list-group-item list-group-item-action" aria-label="Abschlussarbeit">
                                            <i class="bi bi-file-text"></i><span class="d-none d-sm-inline"> Abschlussarbeit</span>
                                        </a>
                                    }
                                    else
                                    {
                                        if (Model.Student.Curriculum.ThesisDuration > 0)
                                        {
                                            <a href="@Url.Action("Index", "Thesis")" class="list-group-item list-group-item-action" aria-label="Abschlussarbeit">
                                                <i class="bi bi-file-text"></i><span class="d-none d-sm-inline"> Abschlussarbeit</span>
                                            </a>
                                        }
                                    }
                                }
                                @if (Model.Candidatures.Any())
                                {
                                    <a href="@Url.Action("Index", "Candidature")" class="list-group-item list-group-item-action" aria-label="Aufnahmeverfahren"><i class="bi bi-journals"></i><span class="d-none d-sm-inline"> Aufnahmeverfahren</span></a>
                                }
                                @if (Model.Members.Any())
                                {
                                    <a class="list-group-item list-group-item-action" href="@Url.Action("OfficeHours", "Lecturer")" aria-label="Sprechstunden"><i class="bi bi-people"></i><span class="d-none d-sm-inline"> Sprechstunden</span></a>
                                    <a class="list-group-item list-group-item-action" href="@Url.Action("Index", "ThesisSupervision")" aria-label="Abschlussarbeiten"><i class="bi bi-book"></i><span class="d-none d-sm-inline"> Abschlussarbeiten</span></a>
                                    <a class="list-group-item list-group-item-action" href="@Url.Action("PersonalDates", "Lecturer")" aria-label="Verfügbarkeiten"><i class="bi bi-calendar-check"></i><span class="d-none d-sm-inline"> Verfügbarkeiten</span></a>
                                    <a class="list-group-item list-group-item-action" href="@Url.Action("Index", "CurriculumModule")" aria-label="Module"><i class="bi bi-boxes"></i><span class="d-none d-sm-inline"> Module</span></a>
                                    <a class="list-group-item list-group-item-action" href="@Url.Action("Responsibility", "Courses")" aria-label="Lehrveranstaltungen"><i class="bi bi-play-btn"></i><span class="d-none d-sm-inline"> Lehveranstaltungen</span></a>
                                    <a class="list-group-item list-group-item-action" href="@Url.Action("Card", "Person")" aria-label="Visitenkarte"><i class="bi bi-person-vcard"></i><span class="d-none d-sm-inline"> Vistenkarte</span></a>
                                    <a class="list-group-item list-group-item-action" href="@Url.Action("Index", "VirtualRoom")" aria-label="Virtuele Räume"><i class="bi bi-person-video"></i><span class="d-none d-sm-inline"> Virtuelle Räume</span></a>
                                    <a class="list-group-item list-group-item-action" href="@Url.Action("Index", "Advertisements")" aria-activedescendant="Aushänge"><i class="bi bi-display"></i><span class="d-none d-sm-inline"> Aushänge</span></a>
                                }
                            </div>
                    @*
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwo" aria-expanded="false" aria-controls="flush-collapseTwo">
                                <i class="bi bi-list"></i><span class="d-none d-sm-inline"> Verzeichnisse</span>
                            </button>
                        </h2>
                        <div id="flush-collapseTwo" class="accordion-collapse collapse" data-bs-parent="#accordionFlushExample">
                            <div class="list-group">
                                <a class="list-group-item list-group-item-action" href="@Url.Action("Index", "Dictionary")" aria-label="Vorlesungen">
                                    <i class="bi bi-collection-play"></i><span class="d-none d-sm-inline"> Vorlesungen</span>
                                </a>
                                <a class="list-group-item list-group-item-action" href="@Url.Action("Index", "OfficeHour")" aria-label="Sprechstunden">
                                    <i class="bi bi-person-lines-fill"></i><span class="d-none d-sm-inline"> Sprechstunden</span>
                                </a>
                                <a class="list-group-item list-group-item-action" href="@Url.Action("Index", "Rooms")" aria-label="Räume">
                                    <i class="bi bi-building"></i><span class="d-none d-sm-inline"> Räume</span>
                                </a>
                                <a class="list-group-item list-group-item-action" href="@Url.Action("Curricula", "University")" aria-label="Studienangebote">
                                    <i class="bi bi-award"></i><span class="d-none d-sm-inline"> Studienangebote</span>
                                </a>
                                <a class="list-group-item list-group-item-action" href="@Url.Action("Index", "Assessment")" aria-label="Aufnahmeverfahren">
                                    <i class="bi bi-folder-check"></i><span class="d-none d-sm-inline"> Aufnahmeverfahren</span>
                                </a>
                            </div>
                        </div>
                    </div>
                *@
                </div>
        </nav>
    </div>
    <div class="col-md-10 col-10">
        <div class="card">
            <div class="list-group">
                <div class="list-group-item">
                    <div class="btn-toolbar">
                        <div class="btn-group me-2">
                            <a id="btnBackward" href="javascript:onBack()" class="btn btn-outline-secondary btn-sm" aria-label="Tag zurück"><i class="bi bi-chevron-left"></i></a>
                            <a id="btnForward" href="javascript:onForward()" class="btn btn-outline-secondary btn-sm" aria-label="Tag weiter"><i class="bi bi-chevron-right"></i></a>
                            <a id="btnDelta1" href="javascript:toggleDelta1()" class="btn btn-outline-secondary btn-sm" aria-label="Tagesansicht"><i class="bi bi-plus-slash-minus"></i>1</a>
                            <a id="btnDelta7" href="javascript:toggleDelta7()" class="btn btn-outline-secondary btn-sm" aria-label="7 Tagevorherschau"><i class="bi bi-plus-slash-minus"></i>7</a>
                        </div>
                        <div class="btn-group me-2">
                            <a id="btnDate" href="javascript:toggleDate()" class="btn btn-outline-secondary btn-sm" aria-label="ab aktuellem Tag"><i class="bi bi-calendar-date"></i></a>
                            <a id="btnDay" href="javascript:toggleDay()" class="btn btn-outline-secondary btn-sm" aria-label="ab Wochenbeginn"><i class="bi bi-calendar-day"></i></a>
                        </div>
                        <div class="btn-group me-2">
                            <a id="btnNextDate" href="javascript:toggleNextDate()" class="btn btn-outline-secondary btn-sm" aria-label="Nächste Termine anzeigen"><i class="bi bi-fast-forward"></i></a>
                        </div>
                        <div class="btn-group">
                            <a class="btn btn-sm btn-outline-secondary" href="@Url.Action("Free", "Room")" aria-label="Raumsuche (freie Räume)"><i class="bi bi-building-check"></i></a>
                        </div>
                    </div>
                </div>
            </div>
            <div id="viewAgendaPlaceholder">
                <div class="list-group">
                    <div class="list-group-item">
                        <p class="placeholder-glow">
                            <span class="placeholder col-7"></span>
                            <span class="placeholder col-4"></span>
                            <span class="placeholder col-4"></span>
                            <span class="placeholder col-6"></span>
                            <span class="placeholder col-8"></span>
                        </p>
                    </div>
                </div>
            </div>
            <div class="list-group">
                <div id="viewAgenda"></div>
            </div>
        </div>
    </div>
</div>





@section Scripts {

    <script type="text/javascript" src="@Url.Content("~/Assets/libs/bootstrap-datepicker/js/bootstrap-datepicker.min.js")"></script>
    <script type="text/javascript" src="@Url.Content("~/Assets/libs/bootstrap-datepicker/locales/bootstrap-datepicker.de.min.js")"></script>
    <script type="text/javascript" src="@Url.Content("~/Assets/fillter/scripts/datepicker.js")"></script>

    @*
        <script type="module" src="@Url.Content("~/Assets/libs/md-block/md-block.js")"></script>
    *@

<script>

    var currentDate = new Date();
    var delta = 1;
    var useDayOfWeek = -1;
    var useNextDate = false;
    var useNewLayout = false;

    document.addEventListener('DOMContentLoaded', function () {

        if (localStorage.getItem("grapevine.dashboard.layout.useNewLayout" === null)) {
            useNewLayout = false;
            localStorage.setItem("grapevine.dashboard.layout.useNewLayout", useNewLayout.toString());
            $("#switchLayoutLabel").html("Anzeige bisheriges Layout")
        }
        else {
            var str = localStorage.getItem("grapevine.dashboard.layout.useNewLayout");
            console.log("useNewLayout (string): " + str);
            useNewLayout = (str === 'true');
            console.log("useNewLayout (boolean): " + useNewLayout);
            const element = document.getElementById("switchLayout");
            element.checked = useNewLayout;
        }
            
            updateLayout();

            initDatePickerTopLeft("datepicker", "@ViewBag.Culture.DateTimeFormat.ShortDatePattern", "@ViewBag.Culture.Name");
            onDateChanged("@DateTime.Today.ToString(ViewBag.Culture.DateTimeFormat.ShortDatePattern)");

            //localStorage.removeItem("grapevine.dashboard.delta");
            str = localStorage.getItem("grapevine.dashboard.delta");
            console.log(str);
            delta = Number(str);
            console.log(delta);
            if (delta != 1 && delta != 7) {
                delta = 1;
            }

            str = localStorage.getItem("grapevine.dashboard.dayOfWeek");
            console.log(str);
            useDayOfWeek = Number(str);
            console.log(useDayOfWeek);
            if (useDayOfWeek <= 0 || useDayOfWeek > 7) {
                useDayOfWeek = -1;
            }

            str = localStorage.getItem("grapevine.dashboard.nextDate");
            console.log(str);
            useNextDate = Boolean(str?.toLowerCase()?.trim());
            console.log(useNextDate);

            updateToggleDelta();
            updateToggleDay();
            updateToggleNextDate();

            updateCurrentDate();
        });

        function onSwitchLayout() {
            console.log("Switch Layout");
            const element = document.getElementById("switchLayout");
            useNewLayout = element.checked;
            console.log(useNewLayout);

            localStorage.setItem("grapevine.dashboard.layout.useNewLayout", useNewLayout.toString());

            updateLayout();
    }

    function updateLayout() {
        if (useNewLayout) {
            $("#switchLayoutLabel").html("Anzeige neues Layout")
        } else {
            $("#switchLayoutLabel").html("Anzeige bisheriges Layout")
        }
        if (useNewLayout) {
            $("#newLayout").show();
            $("#oldLayout").hide();
        }
        else {
            $("#newLayout").hide();
            $("#oldLayout").show();
        }
    }

        document.addEventListener('DOMContentLoaded', function () {
            //$("#cardSemester").hide();
            //$("#placeholderSemester").hide();
            //$("#refreshSemester").hide();
            onSemesterChanged(null);

            //$("#placeholderAgenda").hide();

        });

        function onDateChanged(value) {
            // es kommt der formatierte Text an

            $("#listAgenda").hide();
            $("#placeholderAgenda").show();

            $.ajax(
                {
                    type: "POST",
                    url: '@Url.Action("Agenda", "Activity")',
                    data: {
                        day: value
                    },
                    success: function(data, success, xhr) {
                        $('#listAgenda').html(data);
                        $("#listAgenda").show();
                        $("#placeholderAgenda").hide();
                    }
                });
        }


        function onSemesterChanged(semId) {
            // es kommt der formatierte Text an

            $("#refreshSemester").hide();
            $("#cardSemester").hide();
            $("#placeholderSemester").show();


            $.ajax(
                {
                    type: "POST",
                    url: '@Url.Action("Semester", "Dashboard")',
                    data: {
                        semId: semId
                    },
                    success: function(data, success, xhr) {
                        $('#cardSemester').html(data);
                        $("#cardSemester").show();
                        $("#placeholderSemester").hide();
                    }
                });
        }

        function onBack() {
            currentDate.setDate(currentDate.getDate() - delta);
            updateCurrentDate();
        }

        function onForward() {
            currentDate.setDate(currentDate.getDate() + delta);
            updateCurrentDate();
    }

        function toggleDelta1() {
            delta = 1;
            localStorage.setItem("grapevine.dashboard.delta", delta.toString());
            updateToggleDelta();
            updateCurrentDate();
        }

        function toggleDelta7() {
            delta = 7;
            localStorage.setItem("grapevine.dashboard.delta", delta.toString());
            updateToggleDelta();
            updateCurrentDate();
        }

        function toggleDate() {
            useDayOfWeek = -1;
            localStorage.setItem("grapevine.dashboard.dayOfWeek", useDayOfWeek.toString());
            updateToggleDay();

            currentDate = new Date();
            updateCurrentDate();
        }

        function toggleDay() {
            useDayOfWeek = 1;
            localStorage.setItem("grapevine.dashboard.dayOfWeek", useDayOfWeek.toString());
            updateToggleDay();

            currentDate = getNextDayOfWeek(currentDate, 1);
            updateCurrentDate();
        }

        function toggleNextDate() {
            useNextDate = !useNextDate;
            //setItem("grapevine.dashboard.nextDate", useNextDate.toString());
            updateToggleNextDate();

            updateCurrentDate();
        }

    function updateCurrentDate() {
        //$("#dateCurrent").html(currentDate.toLocaleDateString('de-DE'));

            $("#viewAgenda").hide();
            $("#viewAgendaPlaceholder").show();


        $.ajax(
            {
                type: "POST",
                url: '@Url.Action("PersonalAgenda", "Activity")',
                data: {
                    day: currentDate.toISOString(),
                    delta: delta,
                    dayOfWeek: useDayOfWeek,
                    nextDate: useNextDate
                },
                success: function(data, success, xhr) {
                    $('#viewAgenda').html(data);
                    $("#viewAgenda").show();
                    $("#viewAgendaPlaceholder").hide();
                }
            });
    }

    function updateToggleDelta() {
        if (delta == 1) {
            $("#btnDelta1").addClass("active");
            $("#btnDelta7").removeClass("active");
        } else {
            $("#btnDelta7").addClass("active");
            $("#btnDelta1").removeClass("active");
        }
    }

        function updateToggleDay() {
            if (useDayOfWeek < 0) {
                $("#btnDate").addClass("active");
                $("#btnDay").removeClass("active");
            } else {
                $("#btnDay").addClass("active");
                $("#btnDate").removeClass("active");
            }
    }

    function updateToggleNextDate() {
        if (useNextDate) {
            $("#btnNextDate").addClass("active");
        } else {
            $("#btnNextDate").removeClass("active");
        }
    }

         function getNextDayOfWeek(startDate, dayOfWeek) {
          // Clone the date so we don't mutate the original
          const date = new Date(startDate.getTime());

          const currentDay = date.getDay();
          let daysToAdd = dayOfWeek - currentDay;

          // If the day is today or has already passed this week, add 7 days
          if (daysToAdd <= 0) {
            daysToAdd += 7;
          }

          date.setDate(date.getDate() + daysToAdd);

          return date;
        }


</script>


}
